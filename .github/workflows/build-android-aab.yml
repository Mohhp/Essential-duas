name: Build Android AAB

on:
  workflow_dispatch:
    inputs:
      version_code:
        description: "Android versionCode (must be higher than Play current)"
        required: true
        default: "5"
      version_name:
        description: "Android versionName"
        required: true
        default: "1.0.5"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Bubblewrap CLI
        run: npm install -g @bubblewrap/cli

      - name: Accept Android licenses and install build tools
        run: |
          yes | sdkmanager --licenses
          sdkmanager --update
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      - name: Configure Bubblewrap paths
        run: |
          bubblewrap updateConfig --jdkPath="$JAVA_HOME" --androidSdkPath="$ANDROID_SDK_ROOT"

      - name: Validate required secrets
        run: |
          test -n "${{ secrets.KEYSTORE_BASE64 }}"
          test -n "${{ secrets.KEYSTORE_PASSWORD }}"
          test -n "${{ secrets.KEY_PASSWORD }}"

      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > signing.keystore
          ls -lh signing.keystore

      - name: Prepare manifest version + alias
        run: |
          python3 - << 'PY'
          import json
          from pathlib import Path

          path = Path("twa-manifest.json")
          data = json.loads(path.read_text(encoding="utf-8"))
          data["appVersionCode"] = int("${{ github.event.inputs.version_code }}")
          data["appVersion"] = "${{ github.event.inputs.version_name }}"

          alias = "${{ secrets.KEY_ALIAS }}".strip()
          if alias:
              data.setdefault("signingKey", {})["alias"] = alias

          data.setdefault("signingKey", {})["path"] = "./signing.keystore"
          path.write_text(json.dumps(data, indent=2, ensure_ascii=False) + "\n", encoding="utf-8")
          PY

      - name: Generate Android project
        run: bubblewrap update --manifest=./twa-manifest.json

      - name: Build signed bundle
        env:
          BUBBLEWRAP_KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          BUBBLEWRAP_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: bubblewrap build --manifest=./twa-manifest.json --skipPwaValidation

      - name: Show generated artifacts
        run: find . -type f \( -name "*.aab" -o -name "*.apk" \) | sort

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: essential-duas-aab-v${{ github.event.inputs.version_code }}
          path: |
            **/*.aab

      - name: Upload APK (optional)
        uses: actions/upload-artifact@v4
        with:
          name: essential-duas-apk-v${{ github.event.inputs.version_code }}
          path: |
            **/*.apk
